<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="mybatis.mapper.admin">
	
	<select id="selectMemberAdminYears" resultType="String"> <!-- 회원 기록이 있는 년도 -->
		SELECT TO_CHAR(trakingDate,'YYYY') as "year"
		FROM memberHistory
		GROUP BY TO_CHAR(trakingDate,'YYYY')
		ORDER BY "year" ASC
	</select>
	
	<select id="countAllMemberYear" resultType="cYearVo"> <!-- 년도별 누적 회원수 -->
		SELECT
			dates AS "year",
			COUNT(CASE WHEN m2.type='IN' THEN 1 END)-COUNT(CASE WHEN m2.type='OUT' THEN 1 END) AS "cnt"
		FROM
		    (SELECT TO_CHAR(trakingDate,'YYYY') AS dates FROM memberHistory GROUP BY TO_CHAR(trakingDate,'YYYY')) m1,
		    memberHistory m2
		<![CDATA[WHERE TO_DATE(TO_CHAR(m2.trakingDate,'YYYY'), 'YYYY')<=TO_DATE(dates, 'YYYY')]]>
		GROUP BY dates
		ORDER BY dates
	</select>
	
	<select id="countJoinMemberYear" resultType="cYearVo"> <!-- 년도별 가입 건수 -->
		SELECT
		    TO_CHAR(trakingDate,'YYYY') as "year",
		    COUNT(*) AS "cnt"
		FROM memberHistory
		WHERE type='IN'
		GROUP BY TO_CHAR(trakingDate,'YYYY')
		ORDER BY "year" ASC
	</select>
	
	<select id="countWithdrawMemberYear" resultType="cYearVo"> <!-- 년도별 탈퇴 건수 -->
		SELECT
		    TO_CHAR(trakingDate,'YYYY') as "year",
		    COUNT(*) AS "cnt"
		FROM memberHistory
		WHERE type='OUT'
		GROUP BY TO_CHAR(trakingDate,'YYYY')
		ORDER BY "year" ASC
	</select>
	
	<select id="countJoinMemberMonth" resultType="cMonthVo"> <!-- 월별 가입 건수 -->
		SELECT
		    TO_CHAR(trakingDate,'YYYY') as "year",
		    TO_CHAR(trakingDate,'MM') as "month",
		    COUNT(*) AS "cnt"
		FROM memberHistory
		WHERE type='IN'
		GROUP BY TO_CHAR(trakingDate,'YYYY'), TO_CHAR(trakingDate,'MM') 
		ORDER BY "year" ASC, "month" ASC
	</select>
	
	<select id="countWithdrawMemberMonth" resultType="cMonthVo"> <!-- 월별 탈퇴 건수 -->
		SELECT
		    TO_CHAR(trakingDate,'YYYY') as "year",
		    TO_CHAR(trakingDate,'MM') as "month",
		    COUNT(*) AS "cnt"
		FROM memberHistory
		WHERE type='OUT'
		GROUP BY TO_CHAR(trakingDate,'YYYY'), TO_CHAR(trakingDate,'MM') 
		ORDER BY "year" ASC, "month" ASC
	</select>
	
	<select id="countAllProductsByCategory"  resultType="cCategoryVo"> <!-- 현재까지 등록된 삼품의 카테고리별 건수 -->
		SELECT
			category.category,
			COUNT(p_id) AS "cnt"
		FROM category LEFT OUTER JOIN productDetail
		ON category.category = productDetail.category
		GROUP BY category.category
	</select>
	
</mapper>